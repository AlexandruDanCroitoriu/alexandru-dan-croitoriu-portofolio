# Stage 1: Builder
FROM alpine:latest AS builder

RUN apk update

# Basic dependencies
RUN apk add --no-cache git cmake build-base boost-dev openssl-dev

# for postgres
RUN apk add --no-cache postgresql-dev

# for sqlite
RUN apk add --no-cache sqlite-dev

# for compiling tailwind classes
RUN apk add --no-cache nodejs npm curl

# Build Wt library
RUN git clone --branch 4.11-release https://github.com/emweb/wt.git wt && \
    mkdir -p wt/build && \
    cd wt/build && \
    cmake ../ \
        -DENABLE_SQLITE=ON \
        -DENABLE_POSTGRES=ON \
        -DBUILD_EXAMPLES=OFF \
        -DBUILD_TESTS=OFF \
        -DENABLE_LIBWTTEST=OFF && \
    make && \
    make install && \
    cd / && \
    rm -rf wt

RUN cp /usr/local/lib/libwt*.so.* /usr/lib/ || true

# Copy application source
COPY ./src /app/src
COPY ./static /app/static
COPY ./CMakeLists.txt /app/CMakeLists.txt


# Build application
WORKDIR /app/build/release
ARG CACHE_BUST
# Cache busting mechanism to force Docker to rebuild these layers even if the commands haven't changed.
# The CACHE_BUST build argument (set during docker build with --build-arg CACHE_BUST=$(date +%s))
# ensures that when its value changes, Docker will invalidate the cache for this layer and all
# subsequent layers, forcing a fresh execution of the commands. This is useful for ensuring
# dependencies are updated and the latest code changes are included in the build.
RUN echo "CACHE_BUST=${CACHE_BUST}" && cmake -DCMAKE_BUILD_TYPE=Release ../../ 
# Build Tailwind CSS
RUN echo "CACHE_BUST=${CACHE_BUST}" && cd /app/static/stylus/tailwind && \
    npm install && \
    npx @tailwindcss/cli -i ./input.css -o ../../theme/tailwindcss/tailwind.minify.css --minify
RUN echo "CACHE_BUST=${CACHE_BUST}" && make


# Stage 2: Runtime
FROM alpine:latest

# Runtime deps: match toolchain ABI (libstdc++, libgcc)
RUN apk add --no-cache \
    libstdc++ libgcc \
    boost-libs boost-program_options boost-filesystem boost-thread boost-system boost-regex \
    postgresql-libs

# Copy built application and libraries from builder
COPY --from=builder /app/build /app/build 
COPY --from=builder /usr/lib/libwt*.so.* /usr/lib/

# Copy static resources
COPY ./resources /app/resources
COPY ./dbo /app/dbo
COPY ./static/monaco /app/static/monaco
COPY ./static/xml /app/static/xml
COPY ./static/icons /app/static/icons
COPY --from=builder /app/static/theme/tailwindcss/tailwind.minify.css /app/static/theme/tailwindcss/tailwind.minify.css

COPY ./wt_config_release.xml /app/wt_config_release.xml

WORKDIR /app/build/release

CMD ["./alexandru_dan_croitoriu_portofolio", "--docroot", "../../", "-c", "../../wt_config_release.xml", "--http-address", "0.0.0.0", "--http-port", "9020"]
